<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Big Winner - Realtime App</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK (Compat Version - Works everywhere) -->
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-database-compat.js"></script>

    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #f2f5f8; }
        .hidden-screen { display: none !important; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        /* Loader */
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #E54D42; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
<script type="importmap">
{
  "imports": {
    "firebase/": "https://aistudiocdn.com/firebase@^12.6.0/"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body class="text-gray-800">

    <div id="app-container" class="min-h-screen flex justify-center w-full bg-[#f2f5f8]">
        <div class="w-full max-w-md bg-[#f2f5f8] min-h-screen relative shadow-2xl flex flex-col">

            <!-- ================= AUTH SCREEN ================= -->
            <div id="auth-screen" class="flex flex-col h-full">
                <!-- Header -->
                <div class="bg-[#E54D42] w-full pt-12 pb-8 px-6 flex flex-col items-center text-white rounded-b-[2rem] shadow-lg z-10">
                    <div class="italic font-black text-4xl tracking-tighter flex items-center transform scale-110">
                        <div class="mr-2 border-b-[5px] border-white pb-1 inline-block leading-none transform -skew-x-12">
                            <span class="not-italic text-5xl">B</span>
                        </div>
                        <span class="tracking-[0.1em] text-3xl">BIGWINNER</span>
                    </div>
                    <p class="text-[10px] tracking-[0.3em] font-medium opacity-90 uppercase mt-1">Everyone Makes Money</p>
                </div>

                <!-- Tabs -->
                <div class="flex justify-center mt-8 mb-6">
                    <div class="flex flex-col items-center gap-1">
                        <span id="auth-title" class="font-bold text-xl text-[#E54D42] tracking-wide">Login to account</span>
                        <div class="h-[3px] w-12 bg-[#E54D42] rounded-full"></div>
                    </div>
                </div>

                <!-- Form -->
                <form id="auth-form" class="px-6 flex flex-col gap-6">
                    
                    <div class="group">
                        <div class="flex items-center gap-2 mb-2 ml-1">
                            <i data-lucide="mail" class="w-5 h-5 text-[#E54D42]"></i>
                            <span class="text-gray-700 font-semibold text-sm">Mail</span>
                        </div>
                        <input type="email" id="email" placeholder="Please enter the email" class="w-full bg-white rounded-xl px-5 h-14 outline-none text-gray-700 shadow-sm focus:ring-2 focus:ring-[#E54D42]/20" required>
                    </div>

                    <div id="username-field" class="group hidden-screen">
                        <div class="flex items-center gap-2 mb-2 ml-1">
                            <i data-lucide="crown" class="w-5 h-5 text-[#E54D42]"></i>
                            <span class="text-gray-700 font-semibold text-sm">Set username</span>
                        </div>
                        <input type="text" id="username" placeholder="Set login username" class="w-full bg-white rounded-xl px-5 h-14 outline-none text-gray-700 shadow-sm focus:ring-2 focus:ring-[#E54D42]/20">
                    </div>

                    <div class="group">
                        <div class="flex items-center gap-2 mb-2 ml-1">
                            <i data-lucide="lock" class="w-5 h-5 text-[#E54D42]"></i>
                            <span class="text-gray-700 font-semibold text-sm">Password</span>
                        </div>
                        <input type="password" id="password" placeholder="Enter password" class="w-full bg-white rounded-xl px-5 h-14 outline-none text-gray-700 shadow-sm focus:ring-2 focus:ring-[#E54D42]/20" required>
                    </div>

                    <div id="confirm-pass-field" class="group hidden-screen">
                        <div class="flex items-center gap-2 mb-2 ml-1">
                            <i data-lucide="lock" class="w-5 h-5 text-[#E54D42]"></i>
                            <span class="text-gray-700 font-semibold text-sm">Confirm Password</span>
                        </div>
                        <input type="password" id="confirm-password" placeholder="Confirm password" class="w-full bg-white rounded-xl px-5 h-14 outline-none text-gray-700 shadow-sm focus:ring-2 focus:ring-[#E54D42]/20">
                    </div>

                    <div class="mt-4 flex flex-col gap-4">
                        <button type="submit" id="submit-btn" class="w-full bg-[#E54D42] text-white font-bold text-lg h-14 rounded-full shadow-lg shadow-red-200 active:scale-95 transition-transform flex items-center justify-center gap-2">
                            Login
                        </button>
                        <button type="button" id="toggle-auth-btn" class="w-full bg-transparent text-[#E54D42] font-semibold text-base h-12 rounded-full border-2 border-[#E54D42] active:scale-95 transition-transform">
                            Create an account
                        </button>
                    </div>
                </form>

                <div class="mt-8 text-center pb-8">
                    <button id="master-login-btn" class="text-gray-400 text-xs font-semibold hover:text-gray-600 flex items-center justify-center gap-1 mx-auto">
                        <i data-lucide="user-cog" class="w-3 h-3"></i> Login Master
                    </button>
                </div>
            </div>

            <!-- ================= DASHBOARD SCREEN ================= -->
            <div id="dashboard-screen" class="hidden-screen flex flex-col h-full fade-in pb-10">
                
                <!-- Header -->
                <div id="dash-header" class="bg-[#E54D42] w-full pt-8 pb-16 px-6 rounded-b-[2rem] shadow-lg relative z-0 transition-all duration-500">
                    <div class="flex justify-between items-center text-white mb-6">
                        <div class="flex items-center gap-3">
                            <div id="live-indicator" class="bg-white/20 p-2 rounded-full backdrop-blur-sm">
                                <i data-lucide="user" class="w-6 h-6 text-white"></i>
                            </div>
                            <div>
                                <p class="text-xs opacity-80">Welcome back,</p>
                                <p id="user-display-name" class="font-bold text-lg">User</p>
                            </div>
                        </div>
                        <button id="logout-btn" class="bg-white/10 p-2 rounded-lg hover:bg-white/20">
                            <i data-lucide="log-out" class="w-5 h-5 text-white"></i>
                        </button>
                    </div>
                    
                    <div id="live-badge" class="hidden-screen absolute top-20 right-6 flex items-center gap-2 bg-white/20 backdrop-blur-md px-3 py-1 rounded-full animate-pulse">
                        <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                        <span class="text-white text-xs font-bold uppercase tracking-wider">Live</span>
                    </div>
                </div>

                <!-- Stats Card -->
                <div class="px-5 -mt-10 z-10">
                    <div class="bg-white rounded-2xl shadow-xl p-6 flex flex-col gap-4">
                        <div class="flex flex-col items-center border-b border-gray-100 pb-4 relative">
                            <span class="text-gray-500 text-sm font-medium uppercase tracking-wider mb-1">Total Balance</span>
                            <span id="balance-display" class="text-4xl font-black text-[#E54D42]">₹ 0.00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="flex flex-col items-center w-1/2 border-r border-gray-100">
                                <span class="text-gray-400 text-xs font-bold uppercase">Commission</span>
                                <span id="commission-display" class="text-lg font-bold text-gray-800">₹ 0.00</span>
                            </div>
                            <div class="flex flex-col items-center w-1/2">
                                <span class="text-gray-400 text-xs font-bold uppercase">Salary</span>
                                <span id="salary-display" class="text-lg font-bold text-gray-800">₹ 0.00</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Status Banner -->
                <div class="px-5 mt-4" id="status-banner">
                    <!-- Injected by JS -->
                </div>

                <!-- Grid Buttons -->
                <div class="px-5 mt-4 grid grid-cols-2 gap-4 pb-10">
                    
                    <!-- Live Button -->
                    <div id="live-btn" class="bg-white p-4 rounded-xl shadow-sm hover:shadow-md transition-all flex flex-col items-center justify-center gap-3 aspect-square cursor-pointer">
                        <div id="live-icon-bg" class="w-12 h-12 bg-red-50 rounded-full flex items-center justify-center">
                            <i data-lucide="radio" class="w-6 h-6 text-red-500"></i>
                        </div>
                        <span id="live-text" class="text-gray-700 font-bold text-sm text-center">Start Live</span>
                    </div>

                    <!-- Bank Button -->
                    <div id="bank-btn" class="bg-white p-4 rounded-xl shadow-sm hover:shadow-md transition-shadow flex flex-col items-center justify-center gap-3 aspect-square cursor-pointer">
                         <div class="w-12 h-12 bg-blue-50 rounded-full flex items-center justify-center">
                            <i data-lucide="building-2" class="w-6 h-6 text-blue-500"></i>
                        </div>
                        <span class="text-gray-700 font-bold text-sm text-center">Add Bank</span>
                    </div>

                    <!-- Activate Button -->
                    <div id="activate-btn" class="bg-white p-4 rounded-xl shadow-sm hover:shadow-md transition-shadow flex flex-col items-center justify-center gap-3 aspect-square cursor-pointer">
                         <div class="w-12 h-12 bg-green-50 rounded-full flex items-center justify-center">
                            <i data-lucide="check-circle-2" class="w-6 h-6 text-green-500"></i>
                        </div>
                        <span id="activate-text" class="text-gray-700 font-bold text-sm text-center">Activate</span>
                    </div>

                    <!-- Withdraw Button (Disabled) -->
                    <div class="bg-white opacity-60 p-4 rounded-xl shadow-sm flex flex-col items-center justify-center gap-3 aspect-square">
                         <div class="w-12 h-12 bg-orange-50 rounded-full flex items-center justify-center">
                            <i data-lucide="wallet" class="w-6 h-6 text-orange-400"></i>
                        </div>
                        <span class="text-gray-600 font-medium text-sm text-center">Withdraw</span>
                    </div>
                </div>
            </div>

            <!-- ================= ADMIN SCREEN ================= -->
            <div id="admin-screen" class="hidden-screen bg-slate-900 min-h-screen text-white fade-in">
                <div class="bg-slate-900 p-6 flex justify-between items-center shadow-md border-b border-slate-700 sticky top-0 z-50">
                    <div class="flex items-center gap-3">
                        <i data-lucide="user-cog" class="w-8 h-8 text-[#E54D42]"></i>
                        <div>
                            <h2 class="text-xl font-bold">Master Panel</h2>
                            <p class="text-xs text-gray-400">Admin Control Center</p>
                        </div>
                    </div>
                    <button id="admin-logout-btn" class="bg-slate-700 p-2 rounded-lg hover:bg-slate-600">
                        <i data-lucide="log-out" class="w-5 h-5"></i>
                    </button>
                </div>

                <div class="p-6">
                    <!-- Stats -->
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-slate-700 p-4 rounded-xl border border-slate-600">
                            <div class="flex items-center gap-2 mb-2 text-gray-400">
                                <i data-lucide="users" class="w-4 h-4"></i>
                                <span class="text-xs font-bold uppercase">Total Users</span>
                            </div>
                            <span id="admin-total-users" class="text-2xl font-bold">0</span>
                        </div>
                        <div class="bg-slate-700 p-4 rounded-xl border border-slate-600">
                            <div class="flex items-center gap-2 mb-2 text-gray-400">
                                <i data-lucide="banknote" class="w-4 h-4"></i>
                                <span class="text-xs font-bold uppercase">Total Deposit</span>
                            </div>
                            <span id="admin-total-money" class="text-2xl font-bold text-green-400">₹ 0</span>
                        </div>
                    </div>

                    <!-- QR Setup -->
                    <div class="mb-8 bg-slate-700 rounded-xl p-4 border border-slate-600">
                        <h3 class="text-xs uppercase tracking-wider text-gray-500 font-bold mb-4 flex items-center gap-2">
                            <i data-lucide="qr-code" class="w-4 h-4"></i> Global QR Setup
                        </h3>
                        <label class="text-xs font-bold text-gray-300 mb-1 block">Paste Image Link OR UPI ID</label>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="admin-qr-input" placeholder="https://... OR upi://..." class="flex-1 bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-[#E54D42]">
                            <button id="admin-update-qr" class="bg-[#E54D42] px-4 py-2 rounded-lg font-bold text-xs hover:bg-red-600">Update</button>
                        </div>
                        <div class="bg-slate-800 p-3 rounded-lg flex items-center gap-4">
                            <div class="w-16 h-16 bg-white rounded flex items-center justify-center p-1 overflow-hidden">
                                <img id="admin-qr-preview" src="" class="w-full h-full object-contain">
                            </div>
                            <span class="text-xs text-green-400">Live on all devices</span>
                        </div>
                    </div>

                    <!-- Pending List -->
                    <h3 class="text-xs uppercase tracking-wider text-gray-500 font-bold mb-4">Pending Approvals</h3>
                    <div id="pending-list" class="flex flex-col gap-4 pb-10">
                        <!-- Items injected via JS -->
                        <div class="text-center text-gray-500 text-sm py-4">Loading requests...</div>
                    </div>
                </div>
            </div>

            <!-- ================= MODALS ================= -->
            
            <!-- Activate Modal -->
            <div id="activate-modal" class="hidden-screen fixed inset-0 z-50 flex items-center justify-center px-4">
                <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeModals()"></div>
                <div class="bg-white w-full max-w-sm rounded-3xl p-6 relative z-10 max-h-[90vh] overflow-y-auto">
                    <button onclick="closeModals()" class="absolute top-4 right-4 p-2 bg-gray-100 rounded-full hover:bg-gray-200">
                        <i data-lucide="x" class="w-5 h-5 text-gray-600"></i>
                    </button>
                    
                    <div class="text-center mb-6">
                        <h3 class="text-xl font-bold text-gray-800">Activate Account</h3>
                        <p class="text-gray-500 text-sm mt-1">Scan to pay fee</p>
                    </div>

                    <!-- QR Display -->
                    <div class="bg-white border-2 border-[#E54D42] rounded-2xl p-4 mb-6 shadow-xl flex justify-center">
                        <div class="w-full max-w-[280px] aspect-square bg-white flex items-center justify-center overflow-hidden">
                            <img id="modal-qr-img" src="" class="w-full h-full object-contain">
                        </div>
                    </div>

                    <div class="mb-6">
                        <label class="text-xs font-bold text-gray-600 uppercase ml-1 block mb-1">Enter UTR / Ref No.</label>
                        <input type="number" id="utr-input" placeholder="e.g. 321456789012" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 h-12 text-gray-800 font-medium text-lg">
                    </div>

                    <button id="submit-payment-btn" class="w-full bg-[#E54D42] text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition-transform">
                        Submit Payment
                    </button>
                </div>
            </div>

            <!-- Bank Modal -->
            <div id="bank-modal" class="hidden-screen fixed inset-0 z-50 flex items-center justify-center px-4">
                <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeModals()"></div>
                <div class="bg-white w-full max-w-sm rounded-3xl p-6 relative z-10">
                    <button onclick="closeModals()" class="absolute top-4 right-4 p-2 bg-gray-100 rounded-full hover:bg-gray-200">
                        <i data-lucide="x" class="w-5 h-5 text-gray-600"></i>
                    </button>
                    <h3 class="text-xl font-bold text-center mb-6">Add Bank Details</h3>
                    <form id="bank-form" class="flex flex-col gap-4">
                        <input type="text" id="bank-holder" placeholder="Holder Name" required class="w-full bg-gray-50 border-gray-100 rounded-xl px-4 h-12 border">
                        <input type="text" id="bank-upi" placeholder="UPI ID" required class="w-full bg-gray-50 border-gray-100 rounded-xl px-4 h-12 border">
                        <input type="text" id="bank-name" placeholder="Bank Name" required class="w-full bg-gray-50 border-gray-100 rounded-xl px-4 h-12 border">
                        <input type="text" id="bank-account" placeholder="Account Number" required class="w-full bg-gray-50 border-gray-100 rounded-xl px-4 h-12 border">
                        <input type="text" id="bank-ifsc" placeholder="IFSC Code" required class="w-full bg-gray-50 border-gray-100 rounded-xl px-4 h-12 border">
                        <button type="submit" class="w-full bg-[#E54D42] text-white font-bold py-4 rounded-xl shadow-lg mt-2">Save Details</button>
                    </form>
                </div>
            </div>

            <!-- Admin Login Modal -->
            <div id="admin-login-modal" class="hidden-screen fixed inset-0 z-50 flex items-center justify-center px-4">
                <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeModals()"></div>
                <div class="bg-white w-full max-w-sm rounded-3xl p-6 relative z-10">
                     <button onclick="closeModals()" class="absolute top-4 right-4 p-2 bg-gray-100 rounded-full hover:bg-gray-200">
                        <i data-lucide="x" class="w-5 h-5 text-gray-600"></i>
                    </button>
                    <h3 class="text-xl font-bold text-center mb-6">Master Login</h3>
                    <input type="password" id="admin-key-input" placeholder="Enter Master Key" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 h-14 text-lg mb-4">
                    <button id="admin-login-submit" class="w-full bg-[#E54D42] text-white font-bold py-4 rounded-xl shadow-lg">Access Panel</button>
                </div>
            </div>

        </div>
    </div>

    <!-- MAIN LOGIC SCRIPT -->
    <script>
        // --- 1. CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyDTTlGZBnB0V7LF7rWBos-4U7AH6smPMPg",
            authDomain: "scam2006-f557e.firebaseapp.com",
            databaseURL: "https://scam2006-f557e-default-rtdb.firebaseio.com",
            projectId: "scam2006-f557e",
            storageBucket: "scam2006-f557e.firebasestorage.app",
            messagingSenderId: "892038364894",
            appId: "1:892038364894:web:c2a910e1a66266eeefcc4f",
            measurementId: "G-RX4V2SED2T"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- 2. GLOBAL STATE ---
        let currentUser = null;
        let isAuthModeRegister = false;
        let isLive = false;
        let liveInterval = null;

        // --- 3. HELPERS ---
        const sanitizeEmail = (email) => {
            // Firebase doesn't allow '.' in keys. We replace it with ','
            // Also force lowercase so "User@gmail.com" matches "user@gmail.com"
            return email.toLowerCase().replace(/\./g, ',');
        };
        const getEl = (id) => document.getElementById(id);
        const hide = (id) => getEl(id)?.classList.add('hidden-screen');
        const show = (id) => getEl(id)?.classList.remove('hidden-screen');
        
        // Modal Closer
        window.closeModals = () => {
            hide('activate-modal');
            hide('bank-modal');
            hide('admin-login-modal');
        };

        // Init Icons on Load
        document.addEventListener("DOMContentLoaded", () => {
            lucide.createIcons();
        });

        // --- 4. AUTHENTICATION FLOW ---

        // Toggle Login / Register View
        getEl('toggle-auth-btn').addEventListener('click', () => {
            isAuthModeRegister = !isAuthModeRegister;
            const btn = getEl('submit-btn');
            const title = getEl('auth-title');
            const toggle = getEl('toggle-auth-btn');

            if (isAuthModeRegister) {
                show('username-field');
                show('confirm-pass-field');
                btn.innerText = 'Register';
                title.innerText = 'Register your email';
                toggle.innerText = 'Already have an account? Login';
            } else {
                hide('username-field');
                hide('confirm-pass-field');
                btn.innerText = 'Login';
                title.innerText = 'Login to account';
                toggle.innerText = 'Create an account';
            }
        });

        // Handle Form Submit
        getEl('auth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = getEl('submit-btn');
            const email = getEl('email').value.trim();
            const password = getEl('password').value.trim();
            
            if(!email || !password) return alert("Please fill all fields");

            const userId = sanitizeEmail(email);
            const userRef = db.ref('users/' + userId);

            btn.innerHTML = '<div class="loader"></div>'; // Loading Spinner

            try {
                if (isAuthModeRegister) {
                    // REGISTER LOGIC
                    const username = getEl('username').value.trim();
                    const confirmPass = getEl('confirm-password').value.trim();
                    
                    if (password !== confirmPass) throw new Error("Passwords do not match");
                    
                    // Check if exists
                    const snap = await userRef.once('value');
                    if (snap.exists()) throw new Error("User already exists with this email!");

                    // Create User
                    await userRef.set({
                        email: email.toLowerCase(),
                        password: password, // Storing plain for this specific clone request
                        username: username,
                        balance: 0,
                        status: 'inactive',
                        commission: 0,
                        salary: 0,
                        bankDetails: null
                    });
                    
                    alert("Registration Successful! ✅ Please login now.");
                    window.location.reload(); // Refresh to go back to clean login

                } else {
                    // LOGIN LOGIC
                    const snap = await userRef.once('value');
                    if (!snap.exists()) throw new Error("User not found! Please register.");
                    
                    const data = snap.val();
                    if (data.password !== password) throw new Error("Wrong Password!");

                    // Success
                    currentUser = data;
                    initDashboard();
                }
            } catch (err) {
                alert(err.message);
                btn.innerText = isAuthModeRegister ? 'Register' : 'Login';
            }
        });


        // --- 5. DASHBOARD LOGIC ---

        function initDashboard() {
            hide('auth-screen');
            show('dashboard-screen');
            
            const userId = sanitizeEmail(currentUser.email);
            
            // Realtime Listener for THIS user
            db.ref('users/' + userId).on('value', (snap) => {
                if (snap.exists()) {
                    currentUser = snap.val();
                    renderDashboardData();
                }
            });

            // Listener for QR Code
            db.ref('settings/qrCode').on('value', (snap) => {
                const code = snap.val() || 'https://via.placeholder.com/200';
                getEl('modal-qr-img').src = code;
            });
        }

        function renderDashboardData() {
            getEl('user-display-name').innerText = currentUser.username;
            getEl('balance-display').innerText = `₹ ${parseFloat(currentUser.balance).toFixed(2)}`;
            getEl('commission-display').innerText = `₹ ${parseFloat(currentUser.commission).toFixed(2)}`;
            getEl('salary-display').innerText = `₹ ${parseFloat(currentUser.salary).toFixed(2)}`;
            
            // Status Banner
            const banner = getEl('status-banner');
            if (currentUser.status === 'inactive') {
                banner.innerHTML = `
                <div class="bg-orange-50 border border-orange-100 p-3 rounded-xl flex items-center gap-3 text-orange-700 text-sm shadow-sm">
                    <div class="bg-orange-100 p-2 rounded-full"><i data-lucide="lock" class="w-4 h-4"></i></div>
                    <div class="flex flex-col"><span class="font-bold">Account Not Active</span><span class="text-xs opacity-80">Tap activate button below</span></div>
                </div>`;
            } else if (currentUser.status === 'pending') {
                banner.innerHTML = `
                <div class="bg-yellow-50 border border-yellow-100 p-3 rounded-xl flex items-center gap-3 text-yellow-700 text-sm shadow-sm">
                    <div class="bg-yellow-100 p-2 rounded-full animate-pulse"><i data-lucide="clock" class="w-4 h-4"></i></div>
                    <div class="flex flex-col"><span class="font-bold">Verification Pending</span><span class="text-xs opacity-80">Waiting for Master approval</span></div>
                </div>`;
            } else {
                banner.innerHTML = `
                <div class="bg-green-50 border border-green-100 p-3 rounded-xl flex items-center gap-3 text-green-700 text-sm shadow-sm">
                    <div class="bg-green-100 p-2 rounded-full"><i data-lucide="shield-check" class="w-4 h-4"></i></div>
                    <div class="flex flex-col"><span class="font-bold">Account Active</span><span class="text-xs opacity-80">Verified & Secure</span></div>
                </div>`;
            }
            lucide.createIcons(); // Re-render icons in injected HTML
            
            getEl('activate-text').innerText = currentUser.status === 'active' ? 'Activated' : 'Activate';
        }

        // --- 6. USER ACTIONS ---

        // Start Live Earning
        getEl('live-btn').addEventListener('click', () => {
            if (currentUser.status !== 'active') { 
                alert("Activate account first!"); 
                show('activate-modal'); 
                return; 
            }
            if (!currentUser.bankDetails) { 
                alert("Add Bank Details first!"); 
                show('bank-modal'); 
                return; 
            }

            isLive = !isLive;
            const dashHeader = getEl('dash-header');
            const liveText = getEl('live-text');
            const liveIconBg = getEl('live-icon-bg');

            if (isLive) {
                dashHeader.style.backgroundColor = '#D93025';
                show('live-badge');
                liveText.innerText = 'Stop Live';
                liveText.classList.add('text-red-600');
                liveIconBg.classList.add('bg-red-500');
                
                // Simulate Earning Loop
                liveInterval = setInterval(() => {
                    const transaction = Math.floor(Math.random() * 90) + 10; // 10 to 100
                    const comm = transaction * 0.05;
                    const userId = sanitizeEmail(currentUser.email);
                    
                    // Atomic update
                    db.ref(`users/${userId}`).update({
                        balance: currentUser.balance + transaction,
                        commission: currentUser.commission + comm
                    });
                }, 1500); // Every 1.5 seconds

            } else {
                dashHeader.style.backgroundColor = '#E54D42';
                hide('live-badge');
                liveText.innerText = 'Start Live';
                liveText.classList.remove('text-red-600');
                liveIconBg.classList.remove('bg-red-500');
                clearInterval(liveInterval);
            }
        });

        // Submit Payment Request
        getEl('submit-payment-btn').addEventListener('click', async () => {
            const utr = getEl('utr-input').value;
            if (utr.length < 4) return alert("Invalid UTR/Ref Number");
            
            // Check if already pending
            const paySnap = await db.ref('payments').orderByChild('userEmail').equalTo(currentUser.email).once('value');
            let pending = false;
            paySnap.forEach(c => { if(c.val().status === 'pending') pending = true; });
            
            if(pending) return alert("You already have a pending request!");

            // Add Payment
            await db.ref('payments').push({
                userEmail: currentUser.email,
                username: currentUser.username,
                utr: utr,
                amount: 500,
                status: 'pending',
                timestamp: Date.now()
            });
            
            // Update User Status
            await db.ref(`users/${sanitizeEmail(currentUser.email)}`).update({ status: 'pending' });
            
            alert("Payment Submitted! Please wait for approval.");
            hide('activate-modal');
        });

        // Save Bank Details
        getEl('bank-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const details = {
                holder: getEl('bank-holder').value,
                upi: getEl('bank-upi').value,
                bankName: getEl('bank-name').value,
                account: getEl('bank-account').value,
                ifsc: getEl('bank-ifsc').value
            };
            await db.ref(`users/${sanitizeEmail(currentUser.email)}`).update({ bankDetails: details });
            alert("Bank Details Saved!");
            hide('bank-modal');
        });

        // Modals Open/Close
        getEl('activate-btn').addEventListener('click', () => currentUser.status !== 'active' && show('activate-modal'));
        getEl('bank-btn').addEventListener('click', () => show('bank-modal'));
        getEl('logout-btn').addEventListener('click', () => location.reload());


        // --- 7. ADMIN PANEL LOGIC ---

        getEl('master-login-btn').addEventListener('click', () => show('admin-login-modal'));

        getEl('admin-login-submit').addEventListener('click', () => {
            const key = getEl('admin-key-input').value;
            if(key === 'scam2006') {
                hide('admin-login-modal');
                hide('auth-screen');
                show('admin-screen');
                initAdminPanel();
            } else {
                alert("Invalid Key");
            }
        });

        function initAdminPanel() {
            const list = getEl('pending-list');
            
            // Listen to All Data
            db.ref('/').on('value', (snap) => {
                const data = snap.val() || {};
                const users = data.users || {};
                const payments = data.payments || {};

                // Update Stats
                getEl('admin-total-users').innerText = Object.keys(users).length;
                let totalDep = 0;
                Object.values(payments).forEach(p => { if(p.status === 'approved') totalDep += 500; });
                getEl('admin-total-money').innerText = `₹ ${totalDep}`;

                // Update QR Preview
                const qr = data.settings?.qrCode || '';
                getEl('admin-qr-preview').src = qr;

                // Render Pending List
                list.innerHTML = '';
                let hasPending = false;
                
                // Convert payments object to array & sort newest first
                const payArr = Object.entries(payments).map(([k,v]) => ({key:k, ...v}));
                payArr.sort((a,b) => b.timestamp - a.timestamp);

                payArr.forEach(p => {
                    if (p.status === 'pending') {
                        hasPending = true;
                        const div = document.createElement('div');
                        div.className = "bg-slate-700 rounded-xl p-4 border border-slate-600";
                        div.innerHTML = `
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <p class="font-bold text-white text-sm">${p.username}</p>
                                    <p class="text-xs text-gray-400">${p.userEmail}</p>
                                </div>
                                <span class="bg-yellow-500/20 text-yellow-400 text-[10px] px-2 py-1 rounded font-bold">₹ 500</span>
                            </div>
                            <div class="bg-slate-800 rounded-lg p-3 mb-4 flex justify-between items-center">
                                <span class="text-xs text-gray-500">UTR:</span>
                                <span class="text-sm text-gray-200 font-mono font-bold">${p.utr}</span>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="rejectPayment('${p.key}', '${p.userEmail}')" class="flex-1 py-3 rounded-lg bg-red-500/10 text-red-400 font-bold text-xs border border-red-500/20 hover:bg-red-500/20">Reject</button>
                                <button onclick="approvePayment('${p.key}', '${p.userEmail}')" class="flex-1 py-3 rounded-lg bg-green-600 text-white font-bold text-xs hover:bg-green-500">Approve</button>
                            </div>
                        `;
                        list.appendChild(div);
                    }
                });

                if(!hasPending) list.innerHTML = '<div class="text-center text-gray-500 text-xs italic">No pending requests</div>';
            });
        }

        // Admin Action Functions (Global for HTML onClick)
        window.approvePayment = async (pid, email) => {
            const userId = sanitizeEmail(email);
            // Get current balance
            const uSnap = await db.ref(`users/${userId}`).once('value');
            let bal = 0;
            if(uSnap.exists()) bal = uSnap.val().balance || 0;

            // Atomic Multi-path Update
            const updates = {};
            updates[`payments/${pid}/status`] = 'approved';
            updates[`users/${userId}/status`] = 'active';
            updates[`users/${userId}/balance`] = bal + 500;
            
            await db.ref().update(updates);
        };

        window.rejectPayment = async (pid, email) => {
            const userId = sanitizeEmail(email);
            const updates = {};
            updates[`payments/${pid}/status`] = 'rejected';
            updates[`users/${userId}/status`] = 'inactive';
            
            await db.ref().update(updates);
        };

        // QR Update Logic
        getEl('admin-update-qr').addEventListener('click', () => {
            let val = getEl('admin-qr-input').value.trim();
            if(!val) return;
            
            // If it's NOT a link (http/https), assume it's UPI ID and generate QR
            if (!val.startsWith('http') && !val.startsWith('data:image')) {
                // Generate QR using API
                val = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(val)}`;
            }

            db.ref('settings/qrCode').set(val);
            alert("QR Code Updated!");
            getEl('admin-qr-input').value = '';
        });

        getEl('admin-logout-btn').addEventListener('click', () => location.reload());

    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>